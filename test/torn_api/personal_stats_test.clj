(ns torn-api.personal-stats-test
  (:require [torn-api.personal-stats :as ps]
            [clojure.test :refer [deftest is]]
            [clojure.spec.alpha :as s]))

(def example-resp
  {:personalstats
   {:hospital 1337
    :moneymugged 4383805679
    :caytravel 8
    :piehits 6539
    :mailssent 69381
    :revives 736
    :heahits 383
    :logins 9671
    :axehits 396
    :roundsfired 149046
    :virusescoded 205
    :personalsplaced 0
    :lontravel 9
    :bestkillstreak 631
    :attackswon 19149
    :traveltimes 790
    :peopleboughtspent 816417633
    :attacksassisted 53
    :bazaarprofit 2320176
    :bountiescollected 611
    :useractivity 22709948
    :companymailssent 1855
    :dumpsearches 1023
    :totalbountyreward 973387524
    :bountiesplaced 1910
    :failedbusts 6780
    :meritsbought 50
    :cantaken 116
    :peoplebought 638
    :bazaarcustomers 101
    :respectforfaction 62765
    :spousemailssent 1422
    :medstolen 503
    :switravel 424
    :hawtravel 13
    :cantravel 26
    :factionmailssent 46159
    :missionscompleted 1
    :defendslost 1723
    :shohits 104
    :japtravel 7
    :spydone 111
    :theyrunaway 1003
    :smghits 146
    :attacksdraw 458
    :opitaken 50
    :soutravel 33
    :attacksstealthed 12896
    :drugsused 6746
    :defendswon 2244
    :slahits 2815
    :pcptaken 51
    :trainsreceived 152
    :shrtaken 50
    :revivesreceived 487
    :itemssent 3667
    :kettaken 50
    :chitravel 6
    :daysbeendonator 2175
    :friendmailssent 6809
    :missioncreditsearned 20340
    :yourunaway 31
    :bloodwithdrawn 960
    :mextravel 61
    :chahits 328
    :attackcriticalhits 10870
    :argtravel 4
    :pointsbought 191839
    :jailed 10621
    :xantaken 5669
    :auctionsells 0
    :exttaken 50
    :bountiesreceived 97
    :spetaken 50
    :machits 101
    :weaponsbought 84
    :dukecontractscompleted 687
    :largestmug 230050046
    :dubtravel 1
    :grehits 134
    :highestbeaten 100
    :peoplebusted 8557
    :pointssold 9394
    :statenhancersused 1248
    :contractscompleted 687
    :dumpfinds 1006
    :itemsbought 1490
    :itemsboughtabroad 2020
    :classifiedadsplaced 628
    :auctionswon 12
    :networth 711932549071
    :attackslost 212
    :rifhits 4110
    :cityfinds 294
    :victaken 610
    :lsdtaken 50
    :trades 3210
    :defendsstalemated 364
    :medicalitemsused 8304
    :overdosed 202
    :totalbountyspent 1622306694
    :pishits 506
    :bazaarsales 292
    :refills 2949
    :itemsdumped 13771}})

(def coerced-example-resp
  #:torn-api.personal-stats
  {:failed-busts 6780
   :caymans-travel 8
   :temp-hits 134
   :attacks-won 19149
   :items-bought 1490
   :slashing-hits 2815
   :defends-draw 364
   :smg-hits 146
   :defends-ran-away 1003
   :mail-sent 69381
   :attacks-assisted 53
   :defends-won 2244
   :revives 736
   :personals-placed 0
   :mechanical-hits 328
   :bounties-collected 611
   :friend-mail-sent 46159
   :xanax-taken 5669
   :logins 9671
   :auctions-sold 0
   :piercing-hits 6539
   :meds-stolen 503
   :sa-travel 33
   :opium-taken 50
   :times-jailed 10621
   :clubbed-hits 396
   :critical-hits 10870
   :money-mugged 4383805679
   :bails-bought 638
   :overdoses 202
   :largest-mug 230050046
   :rounds-fired 149046
   :duke-contracts-completed 687
   :pistol-hits 506
   :defends-lost 1723
   :hawaii-travel 13
   :speed-taken 50
   :ketamine-taken 50
   :weapons-bought 84
   :attacks-stealthed 12896
   :china-travel 6
   :lsd-taken 50
   :london-travel 9
   :drugs-taken 6746
   :switzerland-travel 424
   :vicodin-taken 610
   :faction-mail-sent 6809
   :times-traveled 790
   :trains-received 152
   :city-finds 294
   :bounties-received 97
   :times-hospitalized 1337
   :activity 22709948
   :spies-done 111
   :bails-spent 816417633
   :attacks-draw 458
   :total-bounty-spent 1622306694
   :viruses-coded 205
   :shrooms-taken 50
   :total-respect 62765
   :rifle-hits 4110
   :dubai-travel 1
   :items-dumped 13771
   :points-sold 9394
   :bazaar-sales 292
   :revives-received 487
   :people-busted 8557
   :bazaar-customers 101
   :merits-bought 50
   :attacks-lost 212
   :best-kill-streak 631
   :spouse-mail-sent 1422
   :argentina-travel 4
   :artillery-hits 383
   :bazaar-profit 2320176
   :machine-gun-hits 101
   :bounties-placed 1910
   :company-mail-sent 1855
   :stat-enhancers-used 1248
   :ecstasy-taken 50
   :mission-credits 20340
   :contracts-completed 687
   :canabis-taken 116
   :days-as-donator 2175
   :points-bought 191839
   :items-bought-abroad 2020
   :dump-finds 1006
   :networth 711932549071
   :pcp-taken 51
   :total-bounty-rewards 973387524
   :items-sent 3667
   :blood-withdrawn 960
   :trades 3210
   :auctions-won 12
   :highest-beaten 100
   :mexico-travel 61
   :medical-items-used 8304
   :attacks-ran-away 31
   :japan-travel 7
   :canada-travel 26
   :classifieds-placed 628
   :refills 2949
   :missions-completed 1
   :dump-searches 1023
   :shotgun-hits 104}
  )

(deftest test-coerce
  (is (s/valid? ::ps/personal-stats (ps/coerce example-resp)))
  (is (s/valid? ::ps/personal-stats (ps/coerce (assoc-in example-resp [:personalstats :refills] nil))))
  (is (not (s/valid? ::ps/personal-stats (ps/coerce (assoc-in example-resp [:personalstats :overdosed] -1)))))
  (is (= (ps/coerce example-resp) (ps/coerce (assoc-in example-resp [:personalstats :nonexistent] 1))))
  (is (= (count (:personalstats example-resp)) (count (ps/coerce example-resp))))
  (is (= coerced-example-resp (ps/coerce example-resp))))
